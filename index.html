<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  
  <style>
    .input-group-btn > select.btn {
        margin-top: 0;
        margin-bottom: 0;
        padding-top: 7px;
        padding-bottom: 7px;
        border-color: #ccc;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Zero-Memo模糊背景產生器<small>beta</small></h1>
    
    <hr />
    
    <div class="row">
      <div class="col-md-6">
        <h2>參數</h2>
        <form id="form">

          <h3>原圖(河道背景)</h3>
          <div class="form-group">
            <div class="input-group">
              <span class="input-group-btn">
                <select id="image-input-type" class="btn">
                  <option value="url">網址</option>
                  <option value="file">檔案</option>
                </select>
              </span>
              <input type="url" id="image-input" class="form-control" required="required" />
            </div>  <!-- div.input-group -->
          </div>  <!-- div.form-group -->
          
          <h3>資訊面板背景</h3>
          <div class="form-group">
            <label>亮度</label>
            <input type="range" id="dashboard-brightness" min="-100" max="100" value="-50" />

            <label>模糊</label>
            <input type="range" id="dashboard-blur-passes" min="0" max="100" value="20" />
          </div>
          
          <h3>噗文背景</h3>
          <div class="form-group">
            <label>亮度</label>
            <input type="range" id="plurk-brightness" min="-100" max="100" value="50" />
            
            <label>模糊</label>
            <input type="range" id="plurk-blur-passes" min="0" max="100" value="20" />
          </div>

          <button type="submit" class="btn btn-lg btn-primary">生成</button>
          <span>((要等蠻久的，好了我會彈個提示</span>
        <form>
      </div>
      <div class="col-md-6">
        <h2>生成物</h2>

        <textarea id="result" class="form-control" style="max-height:500px;"></textarea>
        <button id="copy" type="button" class="btn btn-default">點我複製</button>
      </div>
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/bluebird/3.3.3/bluebird.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/3.0.9/pixi.js"></script>

  <script type="text/javascript">
    (function() {

        function overrideBackground(css, images) {
            var selectors = {
                timeline:  '#timeline_holder',
                dashboard: '#dashboard_holder, .dash-segment-profile :first-child.segment-content',
                plurk:     '.plurk_cnt, #form_holder'
            };

            for (var key in selectors) {
                if (images[key] != undefined) {
                    css += selectors[key] + '{'
                         + 'background-image:url("' + images[key] + '") !important;'
                         + '}';
                }
            }

            return css;

        }

        function getCss() {
            return new Promise(function(resolve, reject) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', './zero-memo/plurk.css');
                xhr.responseType = 'text';

                xhr.onload = function() {
                    resolve(xhr.response);
                };

                xhr.onerror = reject;

                xhr.send();
            });
        }

        function uploadImage(image) {
            return new Promise(function(resolve, reject) {
                if (typeof image == 'string' && image.startsWith('data:')) {
                    image = image.slice(image.indexOf(',') + 1);
                }
                var xhr = new XMLHttpRequest();
                xhr.open('POST', 'https://api.imgur.com/3/image.json');
                xhr.responseType = 'json';
                xhr.setRequestHeader('Authorization', 'Client-ID f2c48785e9ed652');
                xhr.onload = function() {
                    if (!xhr.response.success) return reject(new Error(xhr.response.data.error));
                    resolve(xhr.response.data.link);
                };
                xhr.onerror = reject;
                
                var data = new FormData();
                data.append('image', image);
                xhr.send(data);
            });
        }

        function toPng(canvas) {
            return new Promise(function(resolve, reject) {      
                var FORMAT = 'image/jpeg';

                if (canvas.toBlob) {
                    canvas.toBlob(resolve, FORMAT);
                } else {
                    resolve(canvas.toDataURL(FORMAT));
                }
            });
        }

        function loadImage(src) {
            return new Promise(function(resolve, reject) {
                var image = new Image();
                image.crossOrigin = 'anonymous';
                image.onload = function() {
                    resolve(new PIXI.Texture(new PIXI.BaseTexture(image)));
                }
                image.onerror = reject;
                image.src = src;
            });
        }

        function getUrlInput(input) {
            return new Promise(function(resolve, reject) {
                if (input.type === 'url') {
                    resolve(input.value);
                } else if (input.type === 'file') {
                    var file = input.files[0];
                    var reader = new FileReader();
                    reader.onload = function() {
                        resolve(reader.result);
                    }
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                }
            });
        }

        var render = (function() {
            var renderers = {};
            return function render(key, sprite) {
                return new Promise(function(resolve, reject) {
                    try {
                        if (renderers[key] == undefined) {
                            renderers[key] = new PIXI.WebGLRenderer(0, 0, { transparent: true });
                        }
                        var renderer = renderers[key];
                        renderer.resize(sprite.width, sprite.height);
                        renderer.render(sprite);
                        resolve(renderer.view);
                    } catch(error) {
                        reject(error);
                    }
                });
            };
        }());

        function makeBrightnessFilters(key) {
            var filters = [];
            var matrix = new PIXI.filters.ColorMatrixFilter();
            var brightness = parseInt(document.getElementById(key + '-brightness').value) / 100;
            
            if (brightness < 0) {
                matrix.brightness(brightness + 1);
                filters.push(matrix);
            } else {
                var invert = new PIXI.filters.InvertFilter();

                matrix.brightness(1 - brightness);
                
                filters.push(invert);
                filters.push(matrix);
                filters.push(invert);
            }

            return filters;
        }

        function makeBlurFilters(key) {
            var filters = [];

            var blur = new PIXI.filters.BlurFilter();
            blur.blur = 1;
            blur.passes = parseInt(document.getElementById(key + '-blur-passes').value);

            filters.push(blur);

            return filters;
        }

        function makeFilters(key) {
            return makeBrightnessFilters(key)
                .concat(makeBlurFilters(key))
        }

        var textarea = document.getElementById("result");

        var imageInput = $('#image-input')[0];

        $('#image-input-type').change(function() {
            imageInput.type = this.value;
        });

        $('#form').submit(function(event) {
            event.preventDefault();
            var images = {};

            function setImage(key, value1) {
                return function(value2) {
                    return images[key] = value2 != undefined ? value2 : value1;
                };
            }

            getUrlInput(imageInput)
                .tap(function(url) {
                    return uploadImage(url).then(setImage('timeline'));
                })
                .then(loadImage)
                .then(function(texture) {
                    return Promise.map(['dashboard', 'plurk'], function(key) {
                        var sprite = new PIXI.Sprite(texture);
                        sprite.filters = makeFilters(key, sprite);
                        return render(key, sprite)
                            .then(toPng)
                            .then(uploadImage)
                            .then(setImage(key));
                    });
                })
                .then(getCss)
                .then(function(css) {
                    textarea.value = overrideBackground(css, images);
                    alert('好惹');
                })
                .catch(function(err) {
                    console.error(err);
                    alert('☆生☆成☆大☆失☆敗☆');
                });
        });

        $('#copy').click(function() {
            textarea.select();
            document.execCommand("copy");
        });
    }());
  </script>
</body>
</html>
